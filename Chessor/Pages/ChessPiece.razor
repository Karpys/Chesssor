@using System.Numerics
@using Chessor.Helpers
@implements Chessor.Interfaces.IPickable
<img src="Images/PawnWhite.png" class="chess-piece"
     draggable="false"
     @onmousedown="SelectPiece"
     @onmouseup="DeselectPiece"
     @onmousemove="MovePiece"
     style="left: @_posXpx; top: @_posYpx" 
     >

@code
{
    bool _isSelect = false;
    double _xOffset = 0;
    double _yOffset = 0;
    string _posXpx => $"{(int)Coordinate.X}px";
    string _posYpx => $"{(int)Coordinate.Y}px";
    private Vector2 _coordinate = new Vector2(0, 0);
    
    [Parameter]
    public Chess Chess { get; set; }

    public bool IsSelect => _isSelect;
    public Vector2 Coordinate { get => _coordinate; set => _coordinate = value; }

    protected override void OnAfterRender(bool firstRender)
    {
        base.OnAfterRender(firstRender);

        if (firstRender)
            Initialize();
    }

    private void Initialize()
    {
        Chess.AddPickable(this);
    }

    void SelectPiece(MouseEventArgs e)
    {
        _isSelect = true;
        _yOffset = e.ClientY - Coordinate.Y;
        _xOffset = e.ClientX - Coordinate.X;
    }
    
    void DeselectPiece(MouseEventArgs e)
    {
        _isSelect = false;
        TryPlaceOnBoard(e);
    }

    private void TryPlaceOnBoard(MouseEventArgs e)
    {
        ChessGrid closest = Chess.Board.ChessGrids.GetClosest(Coordinate);
        PlaceOnChessGrid(closest);
    }

    public void PlaceOnChessGrid(ChessGrid chessGrid)
    {
        _coordinate.X = (int)chessGrid.Position.X;
        _coordinate.Y = (int)chessGrid.Position.Y;
        chessGrid.Assign(this);
    }

    void MovePiece(MouseEventArgs e)
    {
        if(!_isSelect)
            return;
        
        _coordinate.X = (int)(e.ClientX - _xOffset);
        _coordinate.Y = (int)(e.ClientY - _yOffset);
    }

}
