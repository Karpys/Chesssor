@using System.Numerics
@using Chessor.Helpers
@implements Chessor.Interfaces.IPickable
<img src="Images/PawnWhite.png" class="chess-piece"
     draggable="false"
     style="left: @_posXpx; top: @_posYpx" 
     >

@code
{
    bool _isSelect = false;
    double _xOffset = 0;
    double _yOffset = 0;
    string _posXpx => $"{(int)Coordinate.X}px";
    string _posYpx => $"{(int)Coordinate.Y}px";
    private Vector2 _coordinate = new Vector2(0, 0);
    
    [Parameter]
    public Chess Chess { get; set; }

    public bool IsSelect => _isSelect;
    public Vector2 Coordinate { get => _coordinate; set => _coordinate = value; }

    protected override void OnAfterRender(bool firstRender)
    {
        base.OnAfterRender(firstRender);

        if (firstRender)
            Initialize();
    }

    private void Initialize()
    {
        Chess.AddPickable(this);
    }

    void SelectPiece(Vector2 mousePosition)
    {
        _isSelect = true;
        _yOffset = mousePosition.Y - Coordinate.Y;
        _xOffset = mousePosition.X - Coordinate.X;
    }
    
    void DeselectPiece(Vector2 mousePosition)
    {
        _isSelect = false;
        TryPlaceOnBoard(mousePosition);
    }

    private void TryPlaceOnBoard(Vector2 mousePosition)
    {
        ChessGrid closest = Chess.Board.ChessGrids.GetClosest(Coordinate,out _);
        PlaceOnChessGrid(closest);
    }

    public void PlaceOnChessGrid(ChessGrid chessGrid)
    {
        _coordinate.X = (int)chessGrid.Position.X;
        _coordinate.Y = (int)chessGrid.Position.Y;
        chessGrid.Assign(this);
        InvokeAsync(StateHasChanged);
    }

    void MovePiece(Vector2 mousePosition)
    {
        if(!_isSelect)
            return;
        
        _coordinate.X = (int)(mousePosition.X - _xOffset);
        _coordinate.Y = (int)(mousePosition.Y - _yOffset);
        InvokeAsync(StateHasChanged);
    }

    public void TryPick(Vector2 mousePosition,out bool isNewPicked)
    {
        if (_isSelect)
        {
            isNewPicked = false;
            return;
        }
        
        _isSelect = true;
        isNewPicked = true;
        SelectPiece(mousePosition);
    }

    public void InPickMovement(Vector2 position)
    {
        MovePiece(position);
    }

    public void Release(Vector2 mousePosition)
    {
        DeselectPiece(mousePosition);
    }
}
